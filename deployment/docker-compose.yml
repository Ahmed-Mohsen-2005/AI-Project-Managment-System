services:
  # ---------------------------------------------------
  # 1. MySQL Database Service (The Database Model)
  # ---------------------------------------------------
  mysql-db:
    image: mysql:8.0
    container_name: aipms_mysql_db
    # Restart if it stops, unless manually stopped
    restart: unless-stopped
    # Mount a volume to keep data persistent across container restarts
    volumes:
      - mysql_data:/var/lib/mysql
    
    # Securely inject environment variables for MySQL setup
    environment:
      # Database access details matching database_config.py's fallback values
<<<<<<< HEAD
      MYSQL_ROOT_PASSWORD: mazen2004
=======
      MYSQL_ROOT_PASSWORD: mazen2004
>>>>>>> 2f8b3c7c4f9e9ed46a4bccf498ed0f5c86fa730b
      MYSQL_DATABASE: AIPMS
      MYSQL_USER: root
      # Note: We use the MySQL root user credentials directly for development simplicity
    
    # --- FIX APPLIED: Robust Health Check using Simple SQL Command ---
    healthcheck:
      # Execute a simple authenticated query that must succeed
<<<<<<< HEAD
      test: ["CMD", "mysql", "--user=root", "--password=mazen2004", "--execute", "SELECT 1"]
=======
      test: ["CMD", "mysql", "--user=root", "--password=mazen2004", "--execute", "SELECT 1"]
>>>>>>> 2f8b3c7c4f9e9ed46a4bccf498ed0f5c86fa730b
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 40s # Increased start period slightly for extra caution
    
  # ---------------------------------------------------
  # 2. AIPMS Core Flask Application (The Controller/View)
  # ---------------------------------------------------
  aipms-core:
    # Build context is set to the project root (../)
    build: 
      context: ..
      dockerfile: deployment/Dockerfile
    container_name: aipms_flask_app
    ports:
      - "5000:5000"
    restart: always
    
    # Application environment variables
    environment:
      # Inject the credentials directly to override 'localhost' and 'fallback' values
      DB_HOST: "mysql-db"            # CRITICAL: Use the service name as the host
      DB_PORT: "3306"
      DB_NAME: "AIPMS"
      DB_USER: "root"                # Use the MySQL root user name
<<<<<<< HEAD
      DB_PASSWORD: "mazen2004" # Use the MySQL root user password
=======
      DB_PASSWORD: "mazen2004" # Use the MySQL root user password
>>>>>>> 2f8b3c7c4f9e9ed46a4bccf498ed0f5c86fa730b
      DB_TYPE: "mysql+pymysql"       # Ensure correct SQLAlchemy dialect
      SECRET_KEY: "Jana-Ahmed-Ali-Mazen-Hany-2025"
      
    # Ensure the Flask app waits for the MySQL service to be ready
    depends_on:
      mysql-db:
        condition: service_healthy
        
    # Volumes for code synchronization (local development)
    volumes:
      - ..:/usr/src/app

# Define the volume for persistent MySQL data storage
volumes:
  mysql_data: