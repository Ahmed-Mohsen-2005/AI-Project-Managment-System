services:
  # ---------------------------------------------------
  # 1. MySQL Database Service
  # ---------------------------------------------------
  mysql-db:
    image: mysql:8.0
    container_name: aipms_mysql_db
    restart: unless-stopped
    volumes:
      - mysql_data:/var/lib/mysql
    command: --lower_case_table_names=1
    environment:
      MYSQL_ROOT_PASSWORD: AhmedMohsen2005
      MYSQL_DATABASE: AIPMS
    
    # Robust Health Check
    healthcheck:
      test: ["CMD", "mysql", "--user=root", "--password=AhmedMohsen2005", "--execute", "SELECT 1"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s

  # ---------------------------------------------------
  # 2. AIPMS Core Flask Application
  # ---------------------------------------------------
  aipms-core:
    build: 
      context: ..
      dockerfile: deployment/Dockerfile
    container_name: aipms_flask_app
    ports:
      - "5000:5000"
    restart: always
    
    # Ensure Flask waits for DB to be ready
    depends_on:
      mysql-db:
        condition: service_healthy

    # Sync code for live updates
    volumes:
      - ..:/usr/src/app

    environment:
      # --- Database Connection ---
      DB_HOST: "mysql-db"
      DB_PORT: "3306"
      DB_NAME: "AIPMS"
      DB_USER: "root"
      DB_PASSWORD: "AhmedMohsen2005"
      DB_TYPE: "mysql+pymysql"
      
      # --- Security ---
      SECRET_KEY: "Jana-Ahmed-Ali-Mazen-Hany-2025"

      # --- GitHub Integration (New) ---
      # Replace these placeholders with the values from your GitHub App settings
      GITHUB_CLIENT_ID: "PLACEHOLDER_CLIENT_ID"
      GITHUB_CLIENT_SECRET: "PLACEHOLDER_CLIENT_SECRET"
      
      # The Public URL from ngrok (This is required for callbacks)
      # WARNING: If you restart ngrok, this URL will change! Update it here.
      BASE_URL: "https://nonfossiliferous-laughingly-malaya.ngrok-free.dev"

      # --- Email Settings (Flask-Mail) ---
      # Update these to send real emails (e.g., for GitHub notifications)
      MAIL_SERVER: "smtp.gmail.com"
      MAIL_PORT: "587"
      MAIL_USE_TLS: "True"
      MAIL_USERNAME: "ahmedazab@gmail.com"
      MAIL_PASSWORD: "irutaktwowcddgkc"

volumes:
  mysql_data: